# Understand what toggles are important for topology recovery
# Ordering of lambdas!

import os
import random

from os.path import join
from nestly.scons import SConsWrap
from nestly import Nest
from SCons.Script import Environment, Command, AddOption
import numpy as np
import itertools

Import('env')
localenv = env.Clone()

# Set up state
base = {'nreps': localenv['NREPS'],
        'output_name': localenv['OUTPUT_NAME']}

nest = SConsWrap(Nest(base_dict=base), '_'+localenv['OUTPUT_NAME'], alias_environment=localenv)

def get_exp_intertarg_len(targ_lams, double_targ):
    tot_haz = sum(targ_lams)
    exp_len = 0
    for i, lam1 in enumerate(targ_lams):
        for j, lam2 in enumerate(targ_lams[i + 1:]):
            tot_haz += lam1 * lam2 * double_targ
            exp_len += (j + 1) * lam1 * lam2 * double_targ

    return exp_len/tot_haz

def get_sorted_permutations(targ_lams, double_targ):
    permutations = itertools.permutations(lams)
    permutation_exp_lens = []
    for p in permutations:
        permutation_exp_lens.append((p, get_exp_intertarg_len(p, double_targ)))
    return list(sorted(permutation_exp_lens, key=lambda m: m[1]))

LAMBDA_SEQUENCES = [1.,0.85,0.7,0.55,0.4,0.25]
DOUBLE_CUT = 0.4
sorted_permutes = get_sorted_permutations(LAMBDA_SEQEUENCES, DOUBLE_CUT)

nest.add(
    'model_seed',
    [903],
    label_func=lambda c: 'model_seed%d' % c,
)

nest.add(
    'permute_idx',
    range(0, len(sorted_permutes), len(sorted_permutes)/10),
    label_func=lambda c: 'permute_idx%d' % c,
)

@nest.add_target_with_env(localenv)
def generate(env, outdir, c):
    lambda_seq = sorted_permutes[c['permute_idx']]
    targ_lambdas = ",".join(map(str, lambda_seq))

    cmd = [
        'python boto_run.py 2 2000 generate_data.py',
    	#'python generate_data.py',
    	'--sampling-rate 0.4',
        '--model-seed',
        c['model_seed'],
        '--data-seed',
        c['permute_idx'],
        '--out-obs-file ${TARGETS[0]}',
        '--out-model-file ${TARGETS[1]}',
        '--log-file ${TARGETS[2]}',
        '--time 1',
        '--start-birth-lambda 100',
        '--birth-lambda 2.3',
        '--num-barcodes',
        8,
        '--min-uniq-alleles 30',
        '--max-uniq-alleles 50',
        '--max-abundance 100',
        '--double-cut-weight',
        DOUBLE_CUT,
        '--target-lambdas',
        targ_lambdas,
        '--trim-zero-probs 0.1 0.1',
        '--trim-poissons 4 4',
        '--trim-long-factor 0.02 0.02',
        '--insert-zero-prob 0.1',
        '--insert-poisson 1',
        '--perturb-target-lambdas-variance 0',
        '--max-tries 20'
    ]
    cmd = []
    return env.Command(
        [
            join(outdir, 'obs_data.pkl'),
            join(outdir, 'true_model.pkl'),
            join(outdir, 'log.txt')],
        [],
        ' '.join(map(str, cmd)))

nest.add(
    'num_barcodes',
    [1],
    label_func=lambda c: "num_barcodes%d" % c,
)

@nest.add_target_with_env(localenv)
def restrict_observed_alleles(env, outdir, c):
    cmd = [
        'python boto_run.py 2 2000 restrict_observed_barcodes.py',
        #'python restrict_observed_barcodes.py',
        '--obs-file ${SOURCES[0]}',
        '--model-file ${SOURCES[1]}',
        '--num-barcodes',
        c['num_barcodes'],
        '--out-obs-file ${TARGETS[0]}',
        '--out-collapsed-tree-file ${TARGETS[1]}',
        '--log-file ${TARGETS[2]}',
    ]
    cmd = []
    return env.Command(
        [
            join(outdir, 'obs_data.pkl'),
            join(outdir, 'collapsed_tree.pkl'),
            join(outdir, 'log_restrict.txt')],
        c['generate'],
        ' '.join(map(str, cmd)))

@nest.add_target_with_env(localenv)
def run_topology(env, outdir, c):
    cmd = [
        'python boto_run.py 2 6000 get_parsimony_topologies.py',
        #'python get_parsimony_topologies.py',
        '--obs-file ${SOURCES[0]}',
        '--out-template-file ${TARGETS[0]}',
        '--log-file ${TARGETS[1]}',
        '--max-random',
        0,
        '--max-random-multifurc',
        4,
        '--num-jumbles 1'
    ]
    cmd = []
    return env.Command(
        [
            join(outdir, 'parsimony_tree0.pkl'),
            join(outdir, 'log_parsimony.txt')],
        [
            c['restrict_observed_alleles'][0]],
        ' '.join(map(str, cmd)))

nest.add(
    'lambda_known',
    [False],
    label_func=lambda c: 'lambda_known%d' % int(c))

nest.add(
    'tot_time_known',
    [True],
    label_func=lambda c: 'tot_time_known%d' % int(c))

@nest.add_target_with_env(localenv)
def run_MLE(env, outdir, c):
    if c['num_barcodes'] == 1:
        penalty_params = "3072,768,192,48,12,3"
    else:
    	penalty_params = "12,6,3,1.5,.75"

    cmd = [
        'python boto_run.py 18 25000 tune_topology.py',
	#'python tune_topology.py',
        '--obs-file ${SOURCES[0]}',
        '--topology-file ${SOURCES[1]}',
        '--true-model-file ${SOURCES[2]}',
        '--true-collapsed-tree-file ${SOURCES[3]}',
        '--out-model-file ${TARGETS[0]}',
        '--log-file ${TARGETS[1]}',
        '--seed',
	c['seed'] + 100,
        '--log-barr 0.0000001',
        '--dist-to-half-pens',
	penalty_params,
        '--max-sum-states 2000',
        '--max-extra-steps 2',
        '--max-iters 10000',
        '--train-split 0.6667',
        '--total-tune-splits',
        3 if c['num_barcodes'] == 1 else 1,
        '--num-inits 1',
        '--lambda-known' if c['lambda_known'] else '',
        '--tot-time-known',
        '--max-topologies 4',
    ]
    #cmd = []
    return env.Command(
        [
            join(outdir, 'tune_fitted_score.pkl'),
            join(outdir, 'tune_fitted_log.txt')],
        [
            c['restrict_observed_alleles'][0],
            c['run_topology'][0],
            c['generate'][1],
            c['restrict_observed_alleles'][1]],
        ' '.join(map(str, cmd)))

