# Check that as we increase number of barcodes, we converge to the truth

import os

from os.path import join
from nestly.scons import SConsWrap
from nestly import Nest
from SCons.Script import Environment, Command, AddOption
import numpy as np

Import('env')
localenv = env.Clone()

# Set up state
nest = SConsWrap(Nest(), localenv['output'], alias_environment=localenv)

MAX_LEAVES = 400

FISH_DATA = {
    "ADR1": {
        "path": "/fh/fast/matsen_e/gestalt/fish_7B_UMI_collapsed_reads/fish_7B_UMI_collapsed_reads.txt",
        "bcode_min_pos": 122,
        "format": 0,
        "branch_pen_params": "128,32,8",
        "target_lam_pen_params": "2,0.5",
        "merge_thres": "4",
    },
    "ADR2": {
        "path": "/fh/fast/matsen_e/gestalt/GSE81713_fish_ADR2_PHYLIP_MIX_gte5_input.annotations.txt",
        "bcode_min_pos": 122,
        "format": 1,
        "branch_pen_params": "128,32,8",
        "target_lam_pen_params": "2,0.5",
        "merge_thres": "4",
    },
    "30hpf_v6_1": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171798_embryos_1_1_v6.stats.txt",
        "bcode_min_pos": 126,
        "format": 2,
    },
    "30hpf_v6_2": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171799_embryos_1_2_v6.stats.txt",
        "bcode_min_pos": 126,
        "format": 2,
    },
    "30hpf_v6_3": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171800_embryos_1_3_v6.stats.txt",
        "bcode_min_pos": 126,
        "format": 2,
    },
    "30hpf_v6_4": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171801_embryos_1_4_v6.stats.txt",
        "bcode_min_pos": 126,
        "format": 2,
    },
    "30hpf_v6_5": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171802_embryos_1_5_v6.stats.txt",
        "bcode_min_pos": 126,
        "format": 2,
    },
    "30hpf_v6_6": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171803_embryos_1_6_v6.stats.txt",
        "bcode_min_pos": 126,
        "format": 2,
    },
    "30hpf_v6_7": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171804_embryos_1_7_v6.stats.txt",
        "bcode_min_pos": 126,
        "format": 2,
    },
    "30hpf_v6_8": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171805_embryos_1_8_v6.stats.txt",
        "bcode_min_pos": 126,
        "format": 2,
    },
    # V7 timecourse experiments, Only the 1x concentration experiments
    "dome1": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171788_Dome_1_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
    },
    "dome3": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171791_Dome_3_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
    },
    "dome5": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171793_Dome_5_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
    },
    "dome8": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171796_Dome_8_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
    },
    "dome9": {
        # There are only 15 alleles -- do not analyze this fish
        "path": "/fh/fast/matsen_e/gestalt/GSM2171797_Dome_9_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
    },
    "dome10": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171790_Dome_10_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
    },
    "3day1": {
        # Has 2745 leaves
        "path": "/fh/fast/matsen_e/gestalt/GSM2171723_3d_1_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
        "branch_pen_params": "128,32,8",
        "target_lam_pen_params": "2,0.5",
        "merge_thres": 4,
    },
    "3day2": {
        # Has 947 leaves
        "path": "/fh/fast/matsen_e/gestalt/GSM2171727_3d_2_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
        "branch_pen_params": "128,32,8",
        "target_lam_pen_params": "2,0.5",
    },
    "3day3": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171729_3d_3_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
        "branch_pen_params": "128,32,8",
        "target_lam_pen_params": "2,0.5",
    },
    "3day4": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171731_3d_4_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
        "branch_pen_params": "128,32,8",
        "target_lam_pen_params": "2,0.5",
    },
    "3day5": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171733_3d_5_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
        "branch_pen_params": "128,32,8",
        "target_lam_pen_params": "2,0.5",
    },
    "3day6": {
        "path": "/fh/fast/matsen_e/gestalt/GSM2171735_3d_6_1x.stats.txt",
        "bcode_min_pos": 122,
        "format": 2,
        "branch_pen_params": "128,32,8",
        "target_lam_pen_params": "2,0.5",
    },
}

nest.add(
    'data',
    [
        #"ADR1",
        #"ADR2",
        #"30hpf_v6_1",
        #"30hpf_v6_2",
        #"30hpf_v6_3",
        #"30hpf_v6_4",
        #"30hpf_v6_5",
        #"30hpf_v6_6",
        #"30hpf_v6_7",
        #"30hpf_v6_8",
        #"dome1",
        #"dome3",
        #"dome5",
        #"dome8",
        #"dome10",
        "3day1",
        #"3day2",
        #"3day3",
        #"3day4",
        #"3day5",
        #"3day6",
    ],
)

@nest.add_target_with_env(localenv)
def read_gestalt(env, outdir, c):
    cmd = [
        'python3 read_gestalt_data.py',
        '--reads-file',
        FISH_DATA[c['data']]['path'],
        '--reads-format',
        FISH_DATA[c['data']]['format'],
        '--bcode-min-pos',
        FISH_DATA[c['data']]['bcode_min_pos'],
        '--out-obs-data ${TARGETS[0]}',
        '--log-file ${TARGETS[1]}',
        '--abundance-thres 1',
	'--time 1',
	'--merge',
        FISH_DATA[c['data']]['merge_thres'],
    ]
    return env.Command(
        [
            join(outdir, 'fish_data.pkl'),
            join(outdir, 'log.txt')],
        [],
        ' '.join(map(str, cmd)))

nest.add(
    'sampling_seed',
    [0],
    label_func=lambda c: "sampling_seed%d" % c)

@nest.add_target_with_env(localenv)
def restrict_observed_alleles(env, outdir, c):
    cmd = [
        'python3 restrict_observed_barcodes.py',
        '--seed',
        c['sampling_seed'],
        '--obs-file ${SOURCES[0]}',
        '--num-barcodes 1',
        '--out-obs-file ${TARGETS[0]}',
        '--log-file ${TARGETS[1]}',
        '--max-leaves',
        MAX_LEAVES,
    ]
    return env.Command(
        [
            join(outdir, 'fish_data_restrict.pkl'),
            join(outdir, 'log_restrict.txt'),
	],
        c['read_gestalt'],
        ' '.join(map(str, cmd)))

@nest.add_target_with_env(localenv)
def run_parsimony(env, outdir, c):
    cmd = [
        'python3 get_parsimony_topologies.py',
        '--obs-file ${SOURCES[0]}',
        '--out-template-file ${TARGETS[0]}',
        '--log-file ${TARGETS[1]}',
        '--num-jumbles',
	1,
        '--max-random',
        0,
        '--max-trees',
        1,
        '--max-random-multifurc',
        1,
    ]
    return env.Command(
        [
            join(outdir, 'parsimony_tree0.pkl'),
            join(outdir, 'log_parsimony.txt'),
        ],
        c['restrict_observed_alleles'],
        ' '.join(map(str, cmd)))

@nest.add_target_with_env(localenv)
def run_chronos(env, outdir, c):
    cmd = [
        'python3 fit_chronos.py',
        '--seed 1',
        '--lambdas',
        '0.0001,0.001,0.01,0.1,1',
        '--obs-file ${SOURCES[0]}',
        '--topology-file ${SOURCES[1]}',
        '--out-model-file ${TARGETS[0]}',
        '--log-file ${TARGETS[1]}',
        '--num-init-random-rearrange 0',
        '--scratch-dir',
	join('analyze_gestalt', outdir, 'scratch'),
    ]
    return env.Command(
        [
            join(outdir, 'chronos_fitted.pkl'),
            join(outdir, 'chronos_fitted.txt')],
        [
            c['restrict_observed_alleles'][0],
            c['run_parsimony'][0]],
        ' '.join(map(str, cmd)))

@nest.add_target_with_env(localenv)
def run_neighbor_joining(env, outdir, c):
    cmd = [
        'python3 fit_neighbor_joining.py',
        '--seed 1',
        '--obs-file ${SOURCES[0]}',
        '--out-model-file ${TARGETS[0]}',
        '--log-file ${TARGETS[1]}',
        '--scratch-dir',
	join('analyze_gestalt', outdir, 'scratch'),
    ]
    return env.Command(
        [
            join(outdir, 'nj_fitted.pkl'),
            join(outdir, 'nj_fitted.txt')],
        [
            c['restrict_observed_alleles'][0]],
        ' '.join(map(str, cmd)))

nest.add(
    'extra_steps',
    [1],
    label_func=lambda c: "extra_steps_%d" % c,
)

@nest.add_target_with_env(localenv)
def run_MLE(env, outdir, c):
    cmd_arg = [
        'python3 tune_topology.py',
        '--obs-file ${SOURCES[0]}',
        '--topology-file ${SOURCES[1]}',
        '--out-model-file ${TARGETS[0]}',
        '--log-file ${TARGETS[1]}',
        '--seed 400',
        '--branch-pen-params',
        FISH_DATA[c['data']]['branch_pen_params'],
        '--target-lam-pen-params',
        FISH_DATA[c['data']]['target_lam_pen_params'],
        '--num-penalty-tune-iters',
        1,
        '--num-penalty-tune-splits',
        4,
        '--max-fit-splits',
        4,
        '--num-chad-tune-iters',
        20,
        '--num-chad-stop',
        10,
        '--max-chad-tune-search',
        9,
        '--max-extra-steps',
        c['extra_steps'],
        '--max-iters 50000',
        '--num-inits 1',
        '--tot-time-known',
        '--num-processes 2',
        '--num-init-random-rearrange 5',
        '--scratch-dir',
	join('analyze_gestalt', outdir, 'scratch'),
    ]
    cmd_arg_str = "'%s'" % ' '.join(map(str, cmd_arg))
    cmd = [
        'python execute.py',
        '--clusters',
        localenv['clusters'],
        "${TARGETS[0]}",
        cmd_arg_str]
    return env.Command(
        [
            join(outdir, 'tune_pen_hanging.pkl'),
            join(outdir, 'tune_pen_hanging.txt'),
	],
        [
            c['restrict_observed_alleles'][0],
            c['run_parsimony'][0],
	],
        ' '.join(map(str, cmd)))
